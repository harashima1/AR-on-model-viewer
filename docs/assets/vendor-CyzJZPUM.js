import{h as A,L as T,d as ke,O as ze,Y as he,Z as se,e as be,P as Te,W as Ce,_ as G,a0 as j,a1 as Ge,a2 as je,q as ae,a3 as Fe,a4 as C,M as Ve,a5 as We,a6 as Je,a7 as Xe,a8 as Ye,a9 as ne,aa as Ze,ab as Ke,ac as Qe,ad as ue,p as qe,ae as et,V as P}from"./three-BbVIs4F1.js";/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const tt=(a,e)=>e.kind==="method"&&e.descriptor&&!("value"in e.descriptor)?{...e,finisher(t){t.createProperty(e.key,a)}}:{kind:"field",key:Symbol(),placement:"own",descriptor:{},originalKey:e.key,initializer(){typeof e.initializer=="function"&&(this[e.key]=e.initializer.call(this))},finisher(t){t.createProperty(e.key,a)}},rt=(a,e,t)=>{e.constructor.createProperty(t,a)};function bt(a){return(e,t)=>t!==void 0?rt(a,e,t):tt(a,e)}/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var K;((K=window.HTMLSlotElement)===null||K===void 0?void 0:K.prototype.assignedElements)!=null;/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const k=window,ce=k.ShadowRoot&&(k.ShadyCSS===void 0||k.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,Oe=Symbol(),fe=new WeakMap;let it=class{constructor(e,t,r){if(this._$cssResult$=!0,r!==Oe)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(ce&&e===void 0){const r=t!==void 0&&t.length===1;r&&(e=fe.get(t)),e===void 0&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),r&&fe.set(t,e))}return e}toString(){return this.cssText}};const st=a=>new it(typeof a=="string"?a:a+"",void 0,Oe),at=(a,e)=>{ce?a.adoptedStyleSheets=e.map(t=>t instanceof CSSStyleSheet?t:t.styleSheet):e.forEach(t=>{const r=document.createElement("style"),i=k.litNonce;i!==void 0&&r.setAttribute("nonce",i),r.textContent=t.cssText,a.appendChild(r)})},ge=ce?a=>a:a=>a instanceof CSSStyleSheet?(e=>{let t="";for(const r of e.cssRules)t+=r.cssText;return st(t)})(a):a;/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var Q;const V=window,me=V.trustedTypes,nt=me?me.emptyScript:"",ve=V.reactiveElementPolyfillSupport,oe={toAttribute(a,e){switch(e){case Boolean:a=a?nt:null;break;case Object:case Array:a=a==null?a:JSON.stringify(a)}return a},fromAttribute(a,e){let t=a;switch(e){case Boolean:t=a!==null;break;case Number:t=a===null?null:Number(a);break;case Object:case Array:try{t=JSON.parse(a)}catch{t=null}}return t}},Ue=(a,e)=>e!==a&&(e==e||a==a),q={attribute:!0,type:String,converter:oe,reflect:!1,hasChanged:Ue},le="finalized";let b=class extends HTMLElement{constructor(){super(),this._$Ei=new Map,this.isUpdatePending=!1,this.hasUpdated=!1,this._$El=null,this._$Eu()}static addInitializer(e){var t;this.finalize(),((t=this.h)!==null&&t!==void 0?t:this.h=[]).push(e)}static get observedAttributes(){this.finalize();const e=[];return this.elementProperties.forEach((t,r)=>{const i=this._$Ep(r,t);i!==void 0&&(this._$Ev.set(i,r),e.push(i))}),e}static createProperty(e,t=q){if(t.state&&(t.attribute=!1),this.finalize(),this.elementProperties.set(e,t),!t.noAccessor&&!this.prototype.hasOwnProperty(e)){const r=typeof e=="symbol"?Symbol():"__"+e,i=this.getPropertyDescriptor(e,r,t);i!==void 0&&Object.defineProperty(this.prototype,e,i)}}static getPropertyDescriptor(e,t,r){return{get(){return this[t]},set(i){const s=this[e];this[t]=i,this.requestUpdate(e,s,r)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)||q}static finalize(){if(this.hasOwnProperty(le))return!1;this[le]=!0;const e=Object.getPrototypeOf(this);if(e.finalize(),e.h!==void 0&&(this.h=[...e.h]),this.elementProperties=new Map(e.elementProperties),this._$Ev=new Map,this.hasOwnProperty("properties")){const t=this.properties,r=[...Object.getOwnPropertyNames(t),...Object.getOwnPropertySymbols(t)];for(const i of r)this.createProperty(i,t[i])}return this.elementStyles=this.finalizeStyles(this.styles),!0}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const r=new Set(e.flat(1/0).reverse());for(const i of r)t.unshift(ge(i))}else e!==void 0&&t.push(ge(e));return t}static _$Ep(e,t){const r=t.attribute;return r===!1?void 0:typeof r=="string"?r:typeof e=="string"?e.toLowerCase():void 0}_$Eu(){var e;this._$E_=new Promise(t=>this.enableUpdating=t),this._$AL=new Map,this._$Eg(),this.requestUpdate(),(e=this.constructor.h)===null||e===void 0||e.forEach(t=>t(this))}addController(e){var t,r;((t=this._$ES)!==null&&t!==void 0?t:this._$ES=[]).push(e),this.renderRoot!==void 0&&this.isConnected&&((r=e.hostConnected)===null||r===void 0||r.call(e))}removeController(e){var t;(t=this._$ES)===null||t===void 0||t.splice(this._$ES.indexOf(e)>>>0,1)}_$Eg(){this.constructor.elementProperties.forEach((e,t)=>{this.hasOwnProperty(t)&&(this._$Ei.set(t,this[t]),delete this[t])})}createRenderRoot(){var e;const t=(e=this.shadowRoot)!==null&&e!==void 0?e:this.attachShadow(this.constructor.shadowRootOptions);return at(t,this.constructor.elementStyles),t}connectedCallback(){var e;this.renderRoot===void 0&&(this.renderRoot=this.createRenderRoot()),this.enableUpdating(!0),(e=this._$ES)===null||e===void 0||e.forEach(t=>{var r;return(r=t.hostConnected)===null||r===void 0?void 0:r.call(t)})}enableUpdating(e){}disconnectedCallback(){var e;(e=this._$ES)===null||e===void 0||e.forEach(t=>{var r;return(r=t.hostDisconnected)===null||r===void 0?void 0:r.call(t)})}attributeChangedCallback(e,t,r){this._$AK(e,r)}_$EO(e,t,r=q){var i;const s=this.constructor._$Ep(e,r);if(s!==void 0&&r.reflect===!0){const n=(((i=r.converter)===null||i===void 0?void 0:i.toAttribute)!==void 0?r.converter:oe).toAttribute(t,r.type);this._$El=e,n==null?this.removeAttribute(s):this.setAttribute(s,n),this._$El=null}}_$AK(e,t){var r;const i=this.constructor,s=i._$Ev.get(e);if(s!==void 0&&this._$El!==s){const n=i.getPropertyOptions(s),l=typeof n.converter=="function"?{fromAttribute:n.converter}:((r=n.converter)===null||r===void 0?void 0:r.fromAttribute)!==void 0?n.converter:oe;this._$El=s,this[s]=l.fromAttribute(t,n.type),this._$El=null}}requestUpdate(e,t,r){let i=!0;e!==void 0&&(((r=r||this.constructor.getPropertyOptions(e)).hasChanged||Ue)(this[e],t)?(this._$AL.has(e)||this._$AL.set(e,t),r.reflect===!0&&this._$El!==e&&(this._$EC===void 0&&(this._$EC=new Map),this._$EC.set(e,r))):i=!1),!this.isUpdatePending&&i&&(this._$E_=this._$Ej())}async _$Ej(){this.isUpdatePending=!0;try{await this._$E_}catch(t){Promise.reject(t)}const e=this.scheduleUpdate();return e!=null&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){var e;if(!this.isUpdatePending)return;this.hasUpdated,this._$Ei&&(this._$Ei.forEach((i,s)=>this[s]=i),this._$Ei=void 0);let t=!1;const r=this._$AL;try{t=this.shouldUpdate(r),t?(this.willUpdate(r),(e=this._$ES)===null||e===void 0||e.forEach(i=>{var s;return(s=i.hostUpdate)===null||s===void 0?void 0:s.call(i)}),this.update(r)):this._$Ek()}catch(i){throw t=!1,this._$Ek(),i}t&&this._$AE(r)}willUpdate(e){}_$AE(e){var t;(t=this._$ES)===null||t===void 0||t.forEach(r=>{var i;return(i=r.hostUpdated)===null||i===void 0?void 0:i.call(r)}),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$Ek(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$E_}shouldUpdate(e){return!0}update(e){this._$EC!==void 0&&(this._$EC.forEach((t,r)=>this._$EO(r,this[r],t)),this._$EC=void 0),this._$Ek()}updated(e){}firstUpdated(e){}};b[le]=!0,b.elementProperties=new Map,b.elementStyles=[],b.shadowRootOptions={mode:"open"},ve==null||ve({ReactiveElement:b}),((Q=V.reactiveElementVersions)!==null&&Q!==void 0?Q:V.reactiveElementVersions=[]).push("1.6.3");/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var ee;const W=window,F=W.trustedTypes,_e=F?F.createPolicy("lit-html",{createHTML:a=>a}):void 0,de="$lit$",$=`lit$${(Math.random()+"").slice(9)}$`,Pe="?"+$,ot=`<${Pe}>`,x=document,H=()=>x.createComment(""),D=a=>a===null||typeof a!="object"&&typeof a!="function",Ie=Array.isArray,lt=a=>Ie(a)||typeof(a==null?void 0:a[Symbol.iterator])=="function",te=`[ 	
\f\r]`,I=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,ye=/-->/g,$e=/>/g,w=RegExp(`>|${te}(?:([^\\s"'>=/]+)(${te}*=${te}*(?:[^ 	
\f\r"'\`<>=]|("|')|))|$)`,"g"),Ae=/'/g,we=/"/g,Re=/^(?:script|style|textarea|title)$/i,dt=a=>(e,...t)=>({_$litType$:a,strings:e,values:t}),Ft=dt(1),O=Symbol.for("lit-noChange"),g=Symbol.for("lit-nothing"),Me=new WeakMap,M=x.createTreeWalker(x,129,null,!1);function He(a,e){if(!Array.isArray(a)||!a.hasOwnProperty("raw"))throw Error("invalid template strings array");return _e!==void 0?_e.createHTML(e):e}const ht=(a,e)=>{const t=a.length-1,r=[];let i,s=e===2?"<svg>":"",n=I;for(let l=0;l<t;l++){const o=a[l];let d,p,c=-1,h=0;for(;h<o.length&&(n.lastIndex=h,p=n.exec(o),p!==null);)h=n.lastIndex,n===I?p[1]==="!--"?n=ye:p[1]!==void 0?n=$e:p[2]!==void 0?(Re.test(p[2])&&(i=RegExp("</"+p[2],"g")),n=w):p[3]!==void 0&&(n=w):n===w?p[0]===">"?(n=i??I,c=-1):p[1]===void 0?c=-2:(c=n.lastIndex-p[2].length,d=p[1],n=p[3]===void 0?w:p[3]==='"'?we:Ae):n===we||n===Ae?n=w:n===ye||n===$e?n=I:(n=w,i=void 0);const u=n===w&&a[l+1].startsWith("/>")?" ":"";s+=n===I?o+ot:c>=0?(r.push(d),o.slice(0,c)+de+o.slice(c)+$+u):o+$+(c===-2?(r.push(void 0),l):u)}return[He(a,s+(a[t]||"<?>")+(e===2?"</svg>":"")),r]};class N{constructor({strings:e,_$litType$:t},r){let i;this.parts=[];let s=0,n=0;const l=e.length-1,o=this.parts,[d,p]=ht(e,t);if(this.el=N.createElement(d,r),M.currentNode=this.el.content,t===2){const c=this.el.content,h=c.firstChild;h.remove(),c.append(...h.childNodes)}for(;(i=M.nextNode())!==null&&o.length<l;){if(i.nodeType===1){if(i.hasAttributes()){const c=[];for(const h of i.getAttributeNames())if(h.endsWith(de)||h.startsWith($)){const u=p[n++];if(c.push(h),u!==void 0){const f=i.getAttribute(u.toLowerCase()+de).split($),_=/([.?@])?(.*)/.exec(u);o.push({type:1,index:s,name:_[2],strings:f,ctor:_[1]==="."?pt:_[1]==="?"?ft:_[1]==="@"?gt:J})}else o.push({type:6,index:s})}for(const h of c)i.removeAttribute(h)}if(Re.test(i.tagName)){const c=i.textContent.split($),h=c.length-1;if(h>0){i.textContent=F?F.emptyScript:"";for(let u=0;u<h;u++)i.append(c[u],H()),M.nextNode(),o.push({type:2,index:++s});i.append(c[h],H())}}}else if(i.nodeType===8)if(i.data===Pe)o.push({type:2,index:s});else{let c=-1;for(;(c=i.data.indexOf($,c+1))!==-1;)o.push({type:7,index:s}),c+=$.length-1}s++}}static createElement(e,t){const r=x.createElement("template");return r.innerHTML=e,r}}function U(a,e,t=a,r){var i,s,n,l;if(e===O)return e;let o=r!==void 0?(i=t._$Co)===null||i===void 0?void 0:i[r]:t._$Cl;const d=D(e)?void 0:e._$litDirective$;return(o==null?void 0:o.constructor)!==d&&((s=o==null?void 0:o._$AO)===null||s===void 0||s.call(o,!1),d===void 0?o=void 0:(o=new d(a),o._$AT(a,t,r)),r!==void 0?((n=(l=t)._$Co)!==null&&n!==void 0?n:l._$Co=[])[r]=o:t._$Cl=o),o!==void 0&&(e=U(a,o._$AS(a,e.values),o,r)),e}class ct{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){var t;const{el:{content:r},parts:i}=this._$AD,s=((t=e==null?void 0:e.creationScope)!==null&&t!==void 0?t:x).importNode(r,!0);M.currentNode=s;let n=M.nextNode(),l=0,o=0,d=i[0];for(;d!==void 0;){if(l===d.index){let p;d.type===2?p=new L(n,n.nextSibling,this,e):d.type===1?p=new d.ctor(n,d.name,d.strings,this,e):d.type===6&&(p=new mt(n,this,e)),this._$AV.push(p),d=i[++o]}l!==(d==null?void 0:d.index)&&(n=M.nextNode(),l++)}return M.currentNode=x,s}v(e){let t=0;for(const r of this._$AV)r!==void 0&&(r.strings!==void 0?(r._$AI(e,r,t),t+=r.strings.length-2):r._$AI(e[t])),t++}}class L{constructor(e,t,r,i){var s;this.type=2,this._$AH=g,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=r,this.options=i,this._$Cp=(s=i==null?void 0:i.isConnected)===null||s===void 0||s}get _$AU(){var e,t;return(t=(e=this._$AM)===null||e===void 0?void 0:e._$AU)!==null&&t!==void 0?t:this._$Cp}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return t!==void 0&&(e==null?void 0:e.nodeType)===11&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=U(this,e,t),D(e)?e===g||e==null||e===""?(this._$AH!==g&&this._$AR(),this._$AH=g):e!==this._$AH&&e!==O&&this._(e):e._$litType$!==void 0?this.g(e):e.nodeType!==void 0?this.$(e):lt(e)?this.T(e):this._(e)}k(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}$(e){this._$AH!==e&&(this._$AR(),this._$AH=this.k(e))}_(e){this._$AH!==g&&D(this._$AH)?this._$AA.nextSibling.data=e:this.$(x.createTextNode(e)),this._$AH=e}g(e){var t;const{values:r,_$litType$:i}=e,s=typeof i=="number"?this._$AC(e):(i.el===void 0&&(i.el=N.createElement(He(i.h,i.h[0]),this.options)),i);if(((t=this._$AH)===null||t===void 0?void 0:t._$AD)===s)this._$AH.v(r);else{const n=new ct(s,this),l=n.u(this.options);n.v(r),this.$(l),this._$AH=n}}_$AC(e){let t=Me.get(e.strings);return t===void 0&&Me.set(e.strings,t=new N(e)),t}T(e){Ie(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let r,i=0;for(const s of e)i===t.length?t.push(r=new L(this.k(H()),this.k(H()),this,this.options)):r=t[i],r._$AI(s),i++;i<t.length&&(this._$AR(r&&r._$AB.nextSibling,i),t.length=i)}_$AR(e=this._$AA.nextSibling,t){var r;for((r=this._$AP)===null||r===void 0||r.call(this,!1,!0,t);e&&e!==this._$AB;){const i=e.nextSibling;e.remove(),e=i}}setConnected(e){var t;this._$AM===void 0&&(this._$Cp=e,(t=this._$AP)===null||t===void 0||t.call(this,e))}}class J{constructor(e,t,r,i,s){this.type=1,this._$AH=g,this._$AN=void 0,this.element=e,this.name=t,this._$AM=i,this.options=s,r.length>2||r[0]!==""||r[1]!==""?(this._$AH=Array(r.length-1).fill(new String),this.strings=r):this._$AH=g}get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}_$AI(e,t=this,r,i){const s=this.strings;let n=!1;if(s===void 0)e=U(this,e,t,0),n=!D(e)||e!==this._$AH&&e!==O,n&&(this._$AH=e);else{const l=e;let o,d;for(e=s[0],o=0;o<s.length-1;o++)d=U(this,l[r+o],t,o),d===O&&(d=this._$AH[o]),n||(n=!D(d)||d!==this._$AH[o]),d===g?e=g:e!==g&&(e+=(d??"")+s[o+1]),this._$AH[o]=d}n&&!i&&this.j(e)}j(e){e===g?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class pt extends J{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===g?void 0:e}}const ut=F?F.emptyScript:"";class ft extends J{constructor(){super(...arguments),this.type=4}j(e){e&&e!==g?this.element.setAttribute(this.name,ut):this.element.removeAttribute(this.name)}}class gt extends J{constructor(e,t,r,i,s){super(e,t,r,i,s),this.type=5}_$AI(e,t=this){var r;if((e=(r=U(this,e,t,0))!==null&&r!==void 0?r:g)===O)return;const i=this._$AH,s=e===g&&i!==g||e.capture!==i.capture||e.once!==i.once||e.passive!==i.passive,n=e!==g&&(i===g||s);s&&this.element.removeEventListener(this.name,this,i),n&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){var t,r;typeof this._$AH=="function"?this._$AH.call((r=(t=this.options)===null||t===void 0?void 0:t.host)!==null&&r!==void 0?r:this.element,e):this._$AH.handleEvent(e)}}class mt{constructor(e,t,r){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=r}get _$AU(){return this._$AM._$AU}_$AI(e){U(this,e)}}const xe=W.litHtmlPolyfillSupport;xe==null||xe(N,L),((ee=W.litHtmlVersions)!==null&&ee!==void 0?ee:W.litHtmlVersions=[]).push("2.8.0");const vt=(a,e,t)=>{var r,i;const s=(r=t==null?void 0:t.renderBefore)!==null&&r!==void 0?r:e;let n=s._$litPart$;if(n===void 0){const l=(i=t==null?void 0:t.renderBefore)!==null&&i!==void 0?i:null;s._$litPart$=n=new L(e.insertBefore(H(),l),l,void 0,t??{})}return n._$AI(a),n};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var re,ie;class z extends b{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){var e,t;const r=super.createRenderRoot();return(e=(t=this.renderOptions).renderBefore)!==null&&e!==void 0||(t.renderBefore=r.firstChild),r}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=vt(t,this.renderRoot,this.renderOptions)}connectedCallback(){var e;super.connectedCallback(),(e=this._$Do)===null||e===void 0||e.setConnected(!0)}disconnectedCallback(){var e;super.disconnectedCallback(),(e=this._$Do)===null||e===void 0||e.setConnected(!1)}render(){return O}}z.finalized=!0,z._$litElement$=!0,(re=globalThis.litElementHydrateSupport)===null||re===void 0||re.call(globalThis,{LitElement:z});const Se=globalThis.litElementPolyfillSupport;Se==null||Se({LitElement:z});((ie=globalThis.litElementVersions)!==null&&ie!==void 0?ie:globalThis.litElementVersions=[]).push("3.3.3");const De=(a,e,t)=>{let r;switch(a){case ne:r=new Uint8ClampedArray(e*t*4);break;case he:r=new Uint16Array(e*t*4);break;case Ye:r=new Uint32Array(e*t*4);break;case Xe:r=new Int8Array(e*t*4);break;case Je:r=new Int16Array(e*t*4);break;case We:r=new Int32Array(e*t*4);break;case se:r=new Float32Array(e*t*4);break;default:throw new Error("Unsupported data type")}return r};let B;const _t=(a,e,t,r)=>{if(B!==void 0)return B;const i=new Ce(1,1,r);e.setRenderTarget(i);const s=new be(new Te,new Ve({color:16777215}));e.render(s,t),e.setRenderTarget(null);const n=De(a,i.width,i.height);return e.readRenderTargetPixels(i,0,0,i.width,i.height,n),i.dispose(),s.geometry.dispose(),s.material.dispose(),B=n[0]!==0,B};class pe{constructor(e){var t,r,i,s,n,l,o,d,p,c,h,u,f,_,S,E;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(y){throw this._renderer.setRenderTarget(null),y}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const X={format:G,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((t=e.renderTargetOptions)===null||t===void 0?void 0:t.anisotropy)!==void 0?(r=e.renderTargetOptions)===null||r===void 0?void 0:r.anisotropy:1,generateMipmaps:((i=e.renderTargetOptions)===null||i===void 0?void 0:i.generateMipmaps)!==void 0?(s=e.renderTargetOptions)===null||s===void 0?void 0:s.generateMipmaps:!1,magFilter:((n=e.renderTargetOptions)===null||n===void 0?void 0:n.magFilter)!==void 0?(l=e.renderTargetOptions)===null||l===void 0?void 0:l.magFilter:T,minFilter:((o=e.renderTargetOptions)===null||o===void 0?void 0:o.minFilter)!==void 0?(d=e.renderTargetOptions)===null||d===void 0?void 0:d.minFilter:T,samples:((p=e.renderTargetOptions)===null||p===void 0?void 0:p.samples)!==void 0?(c=e.renderTargetOptions)===null||c===void 0?void 0:c.samples:void 0,wrapS:((h=e.renderTargetOptions)===null||h===void 0?void 0:h.wrapS)!==void 0?(u=e.renderTargetOptions)===null||u===void 0?void 0:u.wrapS:A,wrapT:((f=e.renderTargetOptions)===null||f===void 0?void 0:f.wrapT)!==void 0?(_=e.renderTargetOptions)===null||_===void 0?void 0:_.wrapT:A};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=pe.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new ke,this._camera=new ze,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!_t(this._type,this._renderer,this._camera,X)){let y;switch(this._type){case he:y=this._renderer.extensions.has("EXT_color_buffer_float")?se:void 0;break}y!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${se}`),this._type=y):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new be(new Te,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Ce(this.width,this.height,X),this._renderTarget.texture.mapping=((S=e.renderTargetOptions)===null||S===void 0?void 0:S.mapping)!==void 0?(E=e.renderTargetOptions)===null||E===void 0?void 0:E.mapping:j}static instantiateRenderer(){const e=new Ge;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=De(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new je(this.toArray(),this.width,this.height,G,this._type,(e==null?void 0:e.mapping)||j,(e==null?void 0:e.wrapS)||A,(e==null?void 0:e.wrapT)||A,(e==null?void 0:e.magFilter)||T,(e==null?void 0:e.minFilter)||T,(e==null?void 0:e.anisotropy)||1,ae);return t.generateMipmaps=(e==null?void 0:e.generateMipmaps)!==void 0?e==null?void 0:e.generateMipmaps:!1,t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof Fe&&Object.values(this.material.uniforms).forEach(t=>{t.value instanceof C&&t.value.dispose()}),Object.values(this.material).forEach(t=>{t instanceof C&&t.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}const yt=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,$t=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class At extends Fe{constructor({gamma:e,offsetHdr:t,offsetSdr:r,gainMapMin:i,gainMapMax:s,maxDisplayBoost:n,hdrCapacityMin:l,hdrCapacityMax:o,sdr:d,gainMap:p}){super({name:"GainMapDecoderMaterial",vertexShader:yt,fragmentShader:$t,uniforms:{sdr:{value:d},gainMap:{value:p},gamma:{value:new P(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:new P().fromArray(t)},offsetSdr:{value:new P().fromArray(r)},gainMapMin:{value:new P().fromArray(i)},gainMapMax:{value:new P().fromArray(s)},weightFactor:{value:(Math.log2(n)-l)/(o-l)}},blending:et,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=n,this._hdrCapacityMin=l,this._hdrCapacityMax=o,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class Ne extends Error{}class Le extends Error{}const R=(a,e,t)=>{const r=new RegExp(`${e}="([^"]*)"`,"i").exec(a);if(r)return r[1];const i=new RegExp(`<${e}[^>]*>([\\s\\S]*?)</${e}>`,"i").exec(a);if(i){const s=i[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return s&&s.length===3?s.map(n=>n.replace(/<\/?rdf:li>/g,"")):i[1].trim()}if(t!==void 0)return t;throw new Error(`Can't find ${e} in gainmap metadata`)},wt=a=>{let e;typeof TextDecoder<"u"?e=new TextDecoder().decode(a):e=a.toString();let t=e.indexOf("<x:xmpmeta");for(;t!==-1;){const r=e.indexOf("x:xmpmeta>",t),i=e.slice(t,r+10);try{const s=R(i,"hdrgm:GainMapMin","0"),n=R(i,"hdrgm:GainMapMax"),l=R(i,"hdrgm:Gamma","1"),o=R(i,"hdrgm:OffsetSDR","0.015625"),d=R(i,"hdrgm:OffsetHDR","0.015625"),p=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(i),c=p?p[1]:"0",h=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(i);if(!h)throw new Error("Incomplete gainmap metadata");const u=h[1];return{gainMapMin:Array.isArray(s)?s.map(f=>parseFloat(f)):[parseFloat(s),parseFloat(s),parseFloat(s)],gainMapMax:Array.isArray(n)?n.map(f=>parseFloat(f)):[parseFloat(n),parseFloat(n),parseFloat(n)],gamma:Array.isArray(l)?l.map(f=>parseFloat(f)):[parseFloat(l),parseFloat(l),parseFloat(l)],offsetSdr:Array.isArray(o)?o.map(f=>parseFloat(f)):[parseFloat(o),parseFloat(o),parseFloat(o)],offsetHdr:Array.isArray(d)?d.map(f=>parseFloat(f)):[parseFloat(d),parseFloat(d),parseFloat(d)],hdrCapacityMin:parseFloat(c),hdrCapacityMax:parseFloat(u)}}catch{}t=e.indexOf("<x:xmpmeta",r)}};class Mt{constructor(e){this.options={debug:e&&e.debug!==void 0?e.debug:!1,extractFII:e&&e.extractFII!==void 0?e.extractFII:!0,extractNonFII:e&&e.extractNonFII!==void 0?e.extractNonFII:!0}}extract(e){return new Promise((t,r)=>{const i=this.options.debug,s=new DataView(e.buffer);if(s.getUint16(0)!==65496){r(new Error("Not a valid jpeg"));return}const n=s.byteLength;let l=2,o=0,d;for(;l<n;){if(++o>250){r(new Error(`Found no marker after ${o} loops 😵`));return}if(s.getUint8(l)!==255){r(new Error(`Not a valid marker at offset 0x${l.toString(16)}, found: 0x${s.getUint8(l).toString(16)}`));return}if(d=s.getUint8(l+1),i&&console.log(`Marker: ${d.toString(16)}`),d===226){i&&console.log("Found APP2 marker (0xffe2)");const p=l+4;if(s.getUint32(p)===1297106432){const c=p+4;let h;if(s.getUint16(c)===18761)h=!1;else if(s.getUint16(c)===19789)h=!0;else{r(new Error("No valid endianness marker found in TIFF header"));return}if(s.getUint16(c+2,!h)!==42){r(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const u=s.getUint32(c+4,!h);if(u<8){r(new Error("Not valid TIFF data! (First offset less than 8)"));return}const f=c+u,_=s.getUint16(f,!h),S=f+2;let E=0;for(let m=S;m<S+12*_;m+=12)s.getUint16(m,!h)===45057&&(E=s.getUint32(m+8,!h));const y=f+2+_*12+4,Y=[];for(let m=y;m<y+E*16;m+=16){const v={MPType:s.getUint32(m,!h),size:s.getUint32(m+4,!h),dataOffset:s.getUint32(m+8,!h),dependantImages:s.getUint32(m+12,!h),start:-1,end:-1,isFII:!1};v.dataOffset?(v.start=c+v.dataOffset,v.isFII=!1):(v.start=0,v.isFII=!0),v.end=v.start+v.size,Y.push(v)}if(this.options.extractNonFII&&Y.length){const m=new Blob([s]),v=[];for(const Z of Y){if(Z.isFII&&!this.options.extractFII)continue;const Be=m.slice(Z.start,Z.end+1,"image/jpeg");v.push(Be)}t(v)}}}l+=2+s.getUint16(l+2)}})}}const xt=async a=>{const e=wt(a);if(!e)throw new Le("Gain map XMP metadata not found");const r=await new Mt({extractFII:!0,extractNonFII:!0}).extract(a);if(r.length!==2)throw new Ne("Gain map recovery image not found");return{sdr:new Uint8Array(await r[0].arrayBuffer()),gainMap:new Uint8Array(await r[1].arrayBuffer()),metadata:e}},Ee=a=>new Promise((e,t)=>{const r=document.createElement("img");r.onload=()=>{e(r)},r.onerror=i=>{t(i)},r.src=URL.createObjectURL(a)});class St extends Ke{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new Qe}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const e=new At({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new C,sdr:new C});return new pe({width:16,height:16,type:he,colorSpace:ae,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,r,i){const s=i?new Blob([i],{type:"image/jpeg"}):void 0,n=new Blob([r],{type:"image/jpeg"});let l,o,d=!1;if(typeof createImageBitmap>"u"){const h=await Promise.all([s?Ee(s):Promise.resolve(void 0),Ee(n)]);o=h[0],l=h[1],d=!0}else{const h=await Promise.all([s?createImageBitmap(s,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(n,{imageOrientation:"flipY"})]);o=h[0],l=h[1]}const p=new C(o||new ImageData(2,2),j,A,A,T,ue,G,ne,1,ae);p.flipY=d,p.needsUpdate=!0;const c=new C(l,j,A,A,T,ue,G,ne,1,qe);c.flipY=d,c.needsUpdate=!0,e.width=l.width,e.height=l.height,e.material.gainMap=p,e.material.sdr=c,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class Ot extends St{load(e,t,r,i){const s=this.prepareQuadRenderer(),n=new Ze(this._internalLoadingManager);return n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setPath(this.path),n.setWithCredentials(this.withCredentials),this.manager.itemStart(e),n.load(e,async l=>{if(typeof l=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const o=new Uint8Array(l);let d,p,c;try{const h=await xt(o);d=h.sdr,p=h.gainMap,c=h.metadata}catch(h){if(h instanceof Le||h instanceof Ne)console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),c={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},d=o;else throw h}try{await this.render(s,c,d,p)}catch(h){this.manager.itemError(e),typeof i=="function"&&i(h),s.disposeOnDemandRenderer();return}typeof t=="function"&&t(s),this.manager.itemEnd(e),s.disposeOnDemandRenderer()},r,l=>{this.manager.itemError(e),typeof i=="function"&&i(l)}),s}}export{vt as D,Ot as H,bt as n,b as u,Ft as x};
